<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de PMOC Profissional</title>
    <!-- Referências Locais para Funcionamento Offline e na Vercel -->
    <script src="./libs/tailwindcss.js"></script>
    <script src="./libs/jspdf.umd.min.js"></script>
    <script src="./libs/html2canvas.min.js"></script>
    <style>
        /* Estilos Gerais e Variáveis de Cor */
        :root {
            --primary-color: #1a3b5d; /* Azul Marinho Escuro */
            --secondary-color: #0077b6; /* Azul Brilhante */
            --light-gray: #f4f7f6;
            --border-color: #dee2e6;
            --text-color: #34495e; /* Wet Asphalt */
            --header-bg: #1a3b5d;
        }
        body { font-family: 'Inter', sans-serif; background-color: #eef2f5; color: var(--text-color); }
        
        /* Estilos do Formulário de Edição */
        #input-form {
            background-color: #ffffff;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23f0f2f5' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        #input-form details {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #fff;
            transition: all 0.2s ease-in-out;
        }
        #input-form details[open] {
            box-shadow: 0 4px 15px -5px rgba(0, 119, 182, 0.2);
            border-color: var(--secondary-color);
        }
        #input-form summary {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            cursor: pointer;
            outline: none;
            font-weight: 600;
            color: var(--primary-color);
        }
        #input-form summary::marker { content: ''; }
        #input-form summary:before {
            content: '►';
            font-size: 0.6em;
            transition: transform 0.2s;
        }
        #input-form details[open] > summary:before {
            transform: rotate(90deg);
        }
        #input-form .input-group input, #input-form .input-group textarea {
            border-radius: 6px;
            border: 1px solid var(--border-color);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #input-form .input-group input:focus, #input-form .input-group textarea:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(0, 119, 182, 0.15);
            outline: none;
        }

        /* Estilos da Página do PMOC para PDF */
        .pmoc-page {
            background-color: white; width: 21cm; min-height: 29.7cm;
            padding: 0; /* Padding removido para controle total do header/footer */
            margin: 0 auto 1rem auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color); display: flex; flex-direction: column;
            position: relative;
        }
        #preview-scaler .pmoc-page:last-child, #pmoc-for-print .pmoc-page:last-child { margin-bottom: 0; }
        .pmoc-page-content { flex-grow: 1; padding: 1cm 1.5cm; }
        .pmoc-header-design {
            background-color: var(--primary-color);
            color: white;
            padding: 0.75cm 1.5cm;
        }
        .pmoc-footer-design {
            background-color: var(--light-gray);
            border-top: 2px solid var(--secondary-color);
            padding: 0.5cm 1.5cm;
            font-size: 0.7rem;
            text-align: center;
            color: var(--text-color);
        }
        h2 {
            font-size: 1.3rem;
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 8px;
            margin-top: 1.5rem;
            margin-bottom: 1.25rem;
        }
        h3.section-title {
            font-size: 1rem;
            background-color: var(--light-gray);
            padding: 0.5rem 0.75rem;
            border-left: 4px solid var(--secondary-color);
            color: var(--primary-color);
            margin-top: 1.25rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        th {
            background-color: var(--header-bg);
            color: white;
            padding: 10px 8px;
            text-align: left;
            font-size: 0.8rem;
            font-weight: 600;
        }
        td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.8rem;
            vertical-align: top;
        }
        .checklist-table td {
            word-break: break-word;
        }
        tbody tr:nth-child(odd) { background-color: var(--light-gray); }
        .logo-img-color { max-width: 190px; max-height: 85px; object-fit: contain; }
        
        /* Estilos da Página de Rosto */
        .cover-page-content {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
        }
        .cover-page-main { text-align: center; }
        .cover-page-main h1 { font-size: 2.2rem; line-height: 1.2; }
        .cover-page-main p { font-size: 1.2rem; color: var(--text-color); }
        .cover-page-client-box {
            margin-top: 4rem;
            padding: 2rem;
            border-top: 4px solid var(--secondary-color);
            border-bottom: 4px solid var(--secondary-color);
        }

        /* Controles de Visualização */
        #editor-container { display: grid; }
        #print-view-container { display: none; }

        @media print {
            body { background-color: white !important; margin: 0; padding: 0; }
            #editor-container, #print-controls { display: none !important; }
            #print-view-container { display: block !important; }
            #preview-scaler { transform: none !important; height: auto !important; }
            .pmoc-page {
                box-shadow: none !important; border: none !important;
                margin: 0 !important; padding: 0 !important;
                page-break-after: always !important;
            }
            .pmoc-page:last-child { page-break-after: avoid !important; }
        }

        /* Estilos para Modal e Toast */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 2rem; border-radius: 8px; text-align: center; max-width: 90%; width: 400px; transform: scale(0.9); transition: transform 0.3s; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .toast-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #2d3748; color: white; padding: 12px 24px; border-radius: 6px; z-index: 1100; opacity: 0; visibility: hidden; transition: opacity 0.5s, transform 0.5s, visibility 0.5s; }
        .toast-notification.visible { opacity: 1; transform: translateX(-50%) translateY(0); visibility: visible; }
    </style>
</head>
<body class="p-2 sm:p-4 md:p-8">

    <div id="editor-container" class="grid grid-cols-1 lg:grid-cols-5 gap-8">
        <!-- Coluna de Inputs -->
        <div id="input-form" class="lg:col-span-2 p-4 sm:p-6 rounded-lg shadow-lg h-fit lg:sticky top-8">
            <h1 class="text-3xl font-bold mb-6 text-slate-800">Gerador de PMOC</h1>
            
            <div class="space-y-4">
                <details class="mb-4" open>
                    <summary>Informações Gerais</summary>
                    <div class="p-4 border-t">
                        <div class="input-group"><label for="clientName">Nome do Cliente</label><input type="text" id="clientName" value="Restaurante Exemplo"></div>
                        <div class="input-group"><label for="clientAddress">Endereço do Cliente</label><input type="text" id="clientAddress" value="Av. Gastronômica, 123, Centro"></div>
                        <div class="input-group"><label for="clientContact">CNPJ do Cliente</label><input type="text" id="clientContact" value="00.000.000/0001-00"></div>
                        <div class="input-group"><label for="documentDate">Data do Documento</label><input type="date" id="documentDate"></div>
                        <div class="input-group"><label for="companyCity">Cidade</label><input type="text" id="companyCity" value="Betim"></div>
                        <hr class="my-4">
                        <div class="input-group"><label for="companyName">Empresa Responsável</label><input type="text" id="companyName" value="Sua Empresa de Climatização"></div>
                        <div class="input-group"><label for="companyAddress">Endereço da Empresa</label><input type="text" id="companyAddress" value="Sua Rua, 456, Seu Bairro"></div>
                        <div class="input-group"><label for="companyCnpj">CNPJ da Empresa</label><input type="text" id="companyCnpj" value="11.111.111/0001-11"></div>
                        <div class="input-group"><label for="companyPhone">Telefone da Empresa</label><input type="text" id="companyPhone" value="(31) 99999-9999"></div>
                        <div class="input-group"><label for="companyEmail">Email da Empresa</label><input type="email" id="companyEmail" value="contato@suaempresa.com"></div>
                        <hr class="my-4">
                        <div class="input-group"><label for="techName">Nome do Responsável</label><input type="text" id="techName" value="Seu Nome Completo"></div>
                        <div class="input-group"><label for="techRole">Função / Cargo</label><input type="text" id="techRole" value="Responsável Técnico"></div>
                        <div class="input-group"><label for="techContact">CREA / CFT</label><input type="text" id="techContact" value="MG000000000"></div>
                    </div>
                </details>

                <details class="mb-4">
                    <summary>Logotipos e Capa</summary>
                    <div class="p-4 border-t">
                        <div class="input-group"><label for="clientLogo">Logo do Cliente</label><input type="file" id="clientLogo" accept="image/*"></div>
                        <div class="input-group"><label for="companyLogo">Logo da Sua Empresa</label><input type="file" id="companyLogo" accept="image/*"></div>
                        <hr class="my-4">
                        <div class="input-group"><label for="coverImage">Imagem de Fundo da Capa (Opcional)</label><input type="file" id="coverImage" accept="image/*"></div>
                        <button id="removeCoverImage" class="mt-2 bg-gray-500 text-white text-sm py-1 px-2 rounded hover:bg-gray-600">Remover Imagem da Capa</button>
                        <hr class="my-4">
                        <div class="input-group"><label for="signatureImage">Upload da Assinatura do Responsável</label><input type="file" id="signatureImage" accept="image/*"></div>
                        <button id="removeSignatureImage" class="mt-2 bg-gray-500 text-white text-sm py-1 px-2 rounded hover:bg-gray-600">Remover Assinatura</button>
                    </div>
                </details>

                <details class="mb-4" open>
                    <summary>Texto da Introdução</summary>
                    <div class="p-4 border-t">
                        <div class="input-group">
                            <label for="introText">Edite o texto da introdução aqui</label>
                            <textarea id="introText" rows="10" class="w-full p-2 border rounded"></textarea>
                        </div>
                    </div>
                </details>

                <details class="mb-4" open>
                    <summary>Ambientes e Equipamentos</summary>
                    <div id="environments-container" class="p-4 border-t space-y-4"></div>
                    <button id="add-environment" class="m-4 bg-indigo-600 text-white py-2 px-4 rounded hover:bg-indigo-700">Adicionar Ambiente</button>
                </details>
                
                <details class="mb-4" open>
                    <summary>Conclusão Final</summary>
                    <div class="p-4 border-t">
                        <div class="input-group">
                            <label for="conclusionText">Texto da Conclusão e Recomendações</label>
                            <textarea id="conclusionText" rows="5" class="w-full p-2 border rounded">Recomenda-se a manutenção da limpeza dos ambientes para garantir a eficiência do sistema de climatização e a qualidade do ar. Manter portas e janelas fechadas durante a operação dos equipamentos. Todas as rotinas de manutenção foram executadas conforme o plano.</textarea>
                        </div>
                    </div>
                </details>
                
                <div class="space-y-3 pt-4">
                    <button id="save-state-button" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 text-lg">Salvar Progresso</button>
                    <button id="prepare-print-button" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 text-lg">Gerar PDF</button>
                    <button id="clear-state-button" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 text-sm">Limpar Dados Salvos</button>
                </div>
            </div>
        </div>

        <!-- Coluna de Preview -->
        <div id="pmoc-preview-container" class="lg:col-span-3">
            <!-- O preview do PMOC será renderizado e escalado aqui -->
        </div>
    </div>
    
    <!-- Container da Visualização de Impressão -->
    <div id="print-view-container">
        <div id="print-controls" class="p-4 bg-gray-800 text-white sticky top-0 z-50 flex flex-wrap justify-center items-center gap-4">
            <p class="font-semibold">Modo de Geração de PDF</p>
            <button id="back-to-editor-button" class="bg-gray-500 hover:bg-gray-600 py-2 px-4 rounded">Voltar ao Editor</button>
            <button id="save-pdf-button" class="bg-blue-600 hover:bg-blue-700 font-bold py-2 px-4 rounded flex items-center justify-center">Baixar PDF</button>
        </div>
        <div id="pmoc-for-print">
            <!-- Conteúdo final para impressão será renderizado aqui -->
        </div>
    </div>

    <!-- TEMPLATES HTML (ocultos) -->
    <div id="templates" class="hidden">
        <div id="environment-template">
            <div class="environment-item border-2 border-dashed p-3 rounded-lg">
                <div class="input-group"><label>Nome do Ambiente</label><input type="text" class="env-name font-semibold text-lg w-full p-1 border-b"></div>
                <div class="input-group"><label>Tipo de Atividade</label><input type="text" class="env-activity w-full text-sm p-1 border rounded"></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <div class="input-group"><label>Ocupantes Fixos</label><input type="text" class="env-occupants-fixed w-full text-sm p-1 border rounded"></div>
                    <div class="input-group"><label>Ocupantes Flutuantes</label><input type="text" class="env-occupants-float w-full text-sm p-1 border rounded"></div>
                </div>
                <div class="input-group"><label>Área Climatizada (m²)</label><input type="text" class="env-area w-full text-sm p-1 border rounded"></div>
                <h4 class="font-semibold mt-3 mb-1 text-sm">Equipamentos:</h4>
                <div class="equipments-container space-y-2 mt-2"></div>
                <button class="add-equipment bg-blue-500 text-white text-sm py-1 px-2 rounded hover:bg-blue-600">Adicionar Equipamento</button>
                <h4 class="font-semibold mt-3 mb-1 text-sm">Checklist de Manutenção (Editável):</h4>
                <!-- Este container permite rolagem horizontal em telas pequenas para a tabela não quebrar o layout -->
                <div class="checklist-container overflow-x-auto"></div>
                <div class="text-right mt-2">
                    <button class="remove-environment bg-red-500 text-white text-sm py-1 px-2 rounded hover:bg-red-600">Remover Ambiente</button>
                </div>
            </div>
        </div>
        <div id="equipment-template">
            <div class="equipment-item border bg-gray-50 p-3 rounded mt-2 relative">
                 <button class="remove-equipment absolute top-2 right-2 text-red-500 hover:text-red-700 font-bold text-lg leading-none p-1">&times;</button>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4">
                    <div class="input-group"><label>Equipamento</label><input type="text" placeholder="Ex: Split" class="equip-type w-full text-sm"></div>
                    <div class="input-group"><label>Fabricante</label><input type="text" placeholder="Ex: LG" class="equip-manufacturer w-full text-sm"></div>
                    <div class="input-group sm:col-span-2"><label>Modelo</label><input type="text" placeholder="Ex: S3NW24K231A" class="equip-model w-full text-sm"></div>
                    <div class="input-group"><label>Capacidade Refrig.</label><input type="text" placeholder="Ex: 22.000 BTU/h" class="equip-capacity-cool w-full text-sm"></div>
                    <div class="input-group"><label>Capacidade Aquec.</label><input type="text" placeholder="Ex: N/A" class="equip-capacity-heat w-full text-sm"></div>
                    <div class="input-group"><label>Gás Refrigerante</label><input type="text" placeholder="Ex: R32" class="equip-gas w-full text-sm"></div>
                    <div class="input-group"><label>Tensão</label><input type="text" placeholder="Ex: 220V" class="equip-voltage w-full text-sm"></div>
                    <div class="input-group"><label>Frequência</label><input type="text" placeholder="Ex: 60Hz" class="equip-frequency w-full text-sm"></div>
                    <div class="input-group"><label>Corrente</label><input type="text" placeholder="Ex: 14,0 A" class="equip-current w-full text-sm"></div>
                    <div class="input-group"><label>Quantidade</label><input type="number" value="1" class="equip-qty w-full text-sm"></div>
                 </div>
            </div>
        </div>
    </div>

    <!-- Modal e Toast -->
    <div id="modal-container" class="modal-overlay">
        <div class="modal-content">
            <p id="modal-message" class="mb-6"></p>
            <div id="modal-buttons" class="flex justify-center gap-4">
                <button id="modal-confirm" class="bg-blue-600 text-white py-2 px-6 rounded hover:bg-blue-700">Confirmar</button>
                <button id="modal-cancel" class="bg-gray-300 py-2 px-6 rounded hover:bg-gray-400">Cancelar</button>
            </div>
        </div>
    </div>
    <div id="toast-container" class="toast-notification">
        <p id="toast-message"></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- DADOS INICIAIS E CONFIGURAÇÕES ---
            const defaultIntroText = `O PMOC, sigla para Plano de Manutenção, Operação e Controle, é um plano estabelecido por lei visando garantir a qualidade do ambiente, preservando assim a saúde das pessoas e das edificações. Ele é baseado em diversos relatórios realizados com uma determinada periodicidade que vão informar sobre falhas, necessidade de manutenção e limpeza e outros dados relativos aos sistemas de climatização de um local.\n\nEm 1998, o Ministério da Saúde baixou a portaria nº 3.523, tornando obrigatória a implementação e disponibilização de um Plano de Manutenção, Operação e Controle (PMOC) em imóveis com sistemas de climatização. Em janeiro de 2018, a Lei 13.589/2018, publicada no Diário Oficial da União, complementou a portaria determinando que todos os edifícios - públicos ou privados - são obrigados a fazer a manutenção de seus sistemas de ar-condicionado.\n\nO PMOC deve obedecer aos parâmetros regulamentados pela Resolução 9/2003 da Agência Nacional de Vigilância Sanitária (Anvisa) e posteriores alterações, bem como às normas da Associação Brasileira de Normas Técnicas (ABNT). Sua ausência configura infração sanitária sujeita às penalidades previstas na Lei nº 6.437 e os valores da infração podem variar de R$ 2.000,00 a R$ 200.000,00.`;
            const checklistTasks = [ { task: "(FILTRO DE AR) LIMPAR ELEMENTO FILTRANTE OU SUBSTITUIR EM CASO DE AVARIAS", freq: "M" }, { task: "(DRENO) VERIFICAR OPERAÇÃO DE DRENAGEM DO CONDENSADOR DA BANDEJA", freq: "M" }, { task: "(BANDEJA DE DRENO) LAVAR AS BANDEIJAS COM REMOÇÃO DO LODO SEM O USO DE DESENGRAXANTES", freq: "T" }, { task: "(EVAPORADOR) VERIFICAR VAZAMENTOS E CORRIGIR SE NECESSÁRIO", freq: "T" }, { task: "(EVAPORADOR) LAVAR A SERPENTINA COM PRODUTO BIODEGRADÁVEL", freq: "S" }, { task: "(EVAPORADOR) VERIFICAR E ELIMINAR SUJEIRA, DANOS E CORROSÃO", freq: "M" }, { task: "(CARCAÇA PLÁSTICA) LIMPEZA UTILIZANDO PRODUTO BIODEGRADÁVEL", freq: "M" }, { task: "(CARCAÇA PLÁSTICA) VERIFICAR ESTADO DE CONSERVAÇÃO", freq: "M" }, { task: "(MOTOR EVAP.) VERIFICAR E ELIMINAR SUJEIRAS, DANOS E CORROSÃO", freq: "M" }, { task: "(MOTOR EVAP.) VERIFICAR RUÍDOS ANORMAIS E LUBRIFICAR SE NECESSÁRIO", freq: "M" }, { task: "(CONDENSADOR) LAVAR E REMOVER INCRUSTRAÇÕES", freq: "T" }, { task: "(CONDENSADOR) VERIFICAR EXISTENCIA DE DANOS E CORROSÃO", freq: "T" }, { task: "(CONDENSADOR) VERIFICAR VIBRAÇÕES E FIXAÇÃO OU RUÍDOS ANORMAIS", freq: "T" }, { task: "(CONDENSADOR) VERIFICAR VEDAÇÃO DOS PAINÉIS DE FECHAMENTO", freq: "T" }, { task: "(MOTOR CONDENS) VERIFICAR RUÍDOS ANORMAIS E LUBRIFICAR", freq: "T" }, { task: "(COMPRESSOR) VERIFICAR FIXAÇÃO, VIBRAÇÕES E RUÍDOS ANORMAIS", freq: "S" }, { task: "(CIRCUITO REFRIGERANTE) VERIFICAR VAZAMENTOS", freq: "T" }, { task: "(CIRCUITO ELÉTRICO) VERIFICAR DISJUNTORES, CONDUTORES E TOMADAS", freq: "M" }, { task: "(CIRCUITO ELÉTRICO) VERIFICAR TODOS OS CONTATOS E BORNES", freq: "M" }, { task: "(CIRCUITO ELÉTRICO) VERIFICAR SENSORES (DEGELO, AMBIENTE, OUTROS)", freq: "T" }, { task: "(CIRCUITO ELÉTRICO) VERIFICAR FUNCIONAMENTO DE DISPOSITIVO DE AQUECIMENTO", freq: "S" }, { task: "(CIRCUITO ELÉTRICO) MEDIR E REGISTRAR TENSÃO, CORRENTE", freq: "M" }, { task: "VERIFICAÇÃO DE PRESSÕES DE BAIXA E ALTA", freq: "S" }, { task: "VERIFICAR SE RETORNO DE AR SE ENCONTRA OBSTRUÍDO", freq: "M" }, { task: "(CIRCUITO REFRIGERANTE) VERIFICAR ISOLAMENTO TÉRMICO", freq: "T" } ];
            const initialData = [ { name: "Área da Frente do Restaurante", activity: "Atendimento ao Cliente", occupantsFixed: "4", occupantsFloat: "10", area: "55m²", equipments: [ { type: 'Split', manufacturer: 'LG', model: 'S3NW24K231A', capacityCool: '22.000 BTU/h', capacityHeat: 'N/A', gas: 'R32', voltage: '220V', frequency: '60Hz', current: '14,0 A', qty: 2 }, { type: 'Cortina de Ar', manufacturer: 'Springer', model: 'ACF1235', capacityCool: '1,20m', capacityHeat: 'N/A', gas: 'N/A', voltage: '220V', frequency: '60Hz', current: 'N/A', qty: 3 } ] }, { name: "Área Meio do Restaurante", activity: "Refeições", occupantsFixed: "N/A", occupantsFloat: "20", area: "146m²", equipments: [ { type: 'Cassete', manufacturer: 'LG', model: 'ATNW48GMLP1', capacityCool: '48.000 BTU/h', capacityHeat: 'N/A', gas: 'R410A', voltage: '220V', frequency: '60Hz', current: '27 A', qty: 2 } ] } ];
            
            // --- ESTADO GLOBAL E ELEMENTOS DO DOM ---
            const formState = {};
            const DOMElements = {
                environmentsContainer: document.getElementById('environments-container'),
                editorPreviewContainer: document.getElementById('pmoc-preview-container'),
                editorContainer: document.getElementById('editor-container'),
                printContainer: document.getElementById('print-view-container'),
                printContentContainer: document.getElementById('pmoc-for-print'),
                inputForm: document.getElementById('input-form'),
                modal: {
                    container: document.getElementById('modal-container'),
                    message: document.getElementById('modal-message'),
                    confirmBtn: document.getElementById('modal-confirm'),
                    cancelBtn: document.getElementById('modal-cancel'),
                },
                toast: {
                    container: document.getElementById('toast-container'),
                    message: document.getElementById('toast-message'),
                }
            };

            // --- FUNÇÕES DE UI (MODAL & TOAST) ---
            function showToast(message) {
                DOMElements.toast.message.textContent = message;
                DOMElements.toast.container.classList.add('visible');
                setTimeout(() => DOMElements.toast.container.classList.remove('visible'), 3000);
            }

            function showModal(message, onConfirm) {
                DOMElements.modal.message.textContent = message;
                DOMElements.modal.container.classList.add('visible');
                
                const newConfirmBtn = DOMElements.modal.confirmBtn.cloneNode(true);
                DOMElements.modal.confirmBtn.parentNode.replaceChild(newConfirmBtn, DOMElements.modal.confirmBtn);
                DOMElements.modal.confirmBtn = newConfirmBtn;

                DOMElements.modal.confirmBtn.onclick = () => {
                    DOMElements.modal.container.classList.remove('visible');
                    onConfirm();
                };
            }
            DOMElements.modal.cancelBtn.onclick = () => DOMElements.modal.container.classList.remove('visible');

            // --- FUNÇÕES DE GERAÇÃO DE HTML (COM NOVO DESIGN) ---
            function generatePMOCHTML() {
                const environments = Array.from(DOMElements.environmentsContainer.querySelectorAll('.environment-item')).map(envEl => ({
                    name: envEl.querySelector('.env-name').value,
                    activity: envEl.querySelector('.env-activity').value,
                    occupantsFixed: envEl.querySelector('.env-occupants-fixed').value,
                    occupantsFloat: envEl.querySelector('.env-occupants-float').value,
                    area: envEl.querySelector('.env-area').value,
                    equipments: Array.from(envEl.querySelectorAll('.equipment-item')).map(eqEl => ({
                        type: eqEl.querySelector('.equip-type').value, manufacturer: eqEl.querySelector('.equip-manufacturer').value, model: eqEl.querySelector('.equip-model').value,
                        capacityCool: eqEl.querySelector('.equip-capacity-cool').value, capacityHeat: eqEl.querySelector('.equip-capacity-heat').value,
                        gas: eqEl.querySelector('.equip-gas').value, voltage: eqEl.querySelector('.equip-voltage').value,
                        frequency: eqEl.querySelector('.equip-frequency').value, current: eqEl.querySelector('.equip-current').value,
                        qty: eqEl.querySelector('.equip-qty').value,
                    })),
                    checklistData: Array.from(envEl.querySelectorAll('.checklist-row')).map(rowEl => ({
                        task: rowEl.dataset.task,
                        m: rowEl.querySelector('.checklist-m').value,
                        t: rowEl.querySelector('.checklist-t').value,
                        s: rowEl.querySelector('.checklist-s').value,
                    }))
                }));

                const data = { ...formState, environments };
                const placeholderSVG = (text) => `data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='170' height='80'%3e%3crect width='170' height='80' style='fill:%23e8eaf6'/%3e%3ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%233949ab' font-family='sans-serif' font-size='14px'%3e${text}%3c/text%3e%3c/svg%3e`;
                data.clientLogo = data.clientLogo || placeholderSVG('Logo Cliente');
                data.companyLogo = data.companyLogo || placeholderSVG('Sua Logo');

                let fullHtml = '';
                fullHtml += generateCoverPage(data);
                fullHtml += generateIntroPage(data);
                fullHtml += generateIdAndListPage(data);
                data.environments.forEach((env, index) => { if(env.name) fullHtml += generateEnvironmentPage(data, env, index); });
                fullHtml += generateConclusionPage(data);
                
                return fullHtml;
            }

            function updatePreview() {
                const html = generatePMOCHTML();
                DOMElements.editorPreviewContainer.innerHTML = `<div id="preview-scaler">${html}</div>`;
                updatePagination(DOMElements.editorPreviewContainer);
                adjustPreviewScaling();
            }
            
            function calculateTotalBTU(environments) {
                let totalBTU = 0;
                environments.forEach(env => {
                    env.equipments.forEach(eq => {
                        const capacityStr = eq.capacityCool || '0';
                        if (capacityStr.toLowerCase().includes('btu')) {
                            const btuValue = parseInt(capacityStr.replace(/\D/g, ''), 10);
                            const qty = parseInt(eq.qty, 10) || 1;
                            if (!isNaN(btuValue)) {
                                totalBTU += btuValue * qty;
                            }
                        }
                    });
                });
                return new Intl.NumberFormat('pt-BR').format(totalBTU);
            }
            
            function formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString + 'T00:00:00'); // Adiciona T00:00:00 para evitar problemas de fuso horário
                return date.toLocaleDateString('pt-BR', { day: 'numeric', month: 'long', year: 'numeric' });
            }

            const generatePageHeader = (d) => `
                <header class="pmoc-header-design">
                    <table style="width: 100%; border-collapse: collapse;">
                        <tbody>
                            <tr>
                                <td style="width: 30%; text-align: left; border: none; padding: 0; vertical-align: middle;">
                                    <h3 class="font-bold text-xl">${d.companyName}</h3>
                                </td>
                                <td style="width: 40%; text-align: center; border: none; padding: 0; vertical-align: middle;">
                                    <p class="font-bold text-2xl">LAUDO TÉCNICO - PMOC</p>
                                </td>
                                <td style="width: 30%; text-align: right; border: none; padding: 0; vertical-align: middle;">
                                    <div class="bg-white p-2 rounded-lg shadow-sm inline-block">
                                        <img src="${d.companyLogo}" class="logo-img-color" style="max-height: 60px;" alt="Logo">
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </header>`;

            const generatePageFooter = (d) => `<footer class="pmoc-footer-design"><p>${d.companyName || ''} | ${d.companyAddress || ''} | Email: ${d.companyEmail || ''} | Telefone: ${d.companyPhone || ''} | <span class="page-number-placeholder"></span></p></footer>`;
            
            const updatePagination = (container) => {
                const pages = container.querySelectorAll('.pmoc-page');
                const numberedPages = Array.from(pages).filter(p => !p.classList.contains('cover-page'));
                const totalNumberedPages = numberedPages.length;
                
                numberedPages.forEach((page, index) => {
                    const pageNumberEl = page.querySelector('.page-number-placeholder');
                    if (pageNumberEl) {
                        pageNumberEl.textContent = `Página ${index + 1} de ${totalNumberedPages}`;
                    }
                });
            };

            const generateCoverPage = (d) => {
                if (d.coverImage) {
                    return `<div class="pmoc-page cover-page" style="background-image: url('${d.coverImage}'); background-size: cover; background-position: center; padding:0;">
                                <!-- O conteúdo é intencionalmente deixado em branco para que a imagem seja a capa completa -->
                            </div>`;
                }
                // Default cover page
                return `<div class="pmoc-page cover-page flex flex-col justify-between" style="padding:0;"><div class="pmoc-header-design"><div class="bg-white p-2 rounded-lg shadow-sm inline-block"><img src="${d.companyLogo}" class="logo-img-color" alt="Logo Empresa"></div><div class="bg-white p-2 rounded-lg shadow-sm inline-block"><img src="${d.clientLogo}" class="logo-img-color" alt="Logo Cliente"></div></div><div class="pmoc-page-content cover-page-main"><h1>PLANO DE MANUTENÇÃO, OPERAÇÃO E CONTROLE</h1><p class="mt-2">Sistemas de Climatização - PMOC</p><div class="cover-page-client-box"><p class="text-2xl font-bold text-slate-800">${d.clientName}</p><p class="text-lg text-slate-600 mt-1">${d.clientAddress}</p></div></div><div class="pmoc-footer-design"><p>${d.companyCity || 'Betim'}, ${formatDate(d.documentDate)}</p></div></div>`;
            };

            const generateIntroPage = (d) => `<div class="pmoc-page">${generatePageHeader(d)}<div class="pmoc-page-content text-sm text-justify"><h2>Introdução</h2><div class="whitespace-pre-wrap">${d.introText || defaultIntroText}</div></div>${generatePageFooter(d)}</div>`;
            const generateIdAndListPage = (d) => `<div class="pmoc-page">${generatePageHeader(d)}<div class="pmoc-page-content"><h2>1. Identificação do Estabelecimento</h2><table class="w-full text-sm"><tbody><tr><th class="w-1/3">Cliente/Edifício:</th><td>${d.clientName}</td></tr><tr><th>Endereço:</th><td>${d.clientAddress}</td></tr><tr><th>CNPJ:</th><td>${d.clientContact}</td></tr></tbody></table><h2>2. Identificação do Responsável</h2><table class="w-full text-sm"><tbody><tr><th class="w-1/3">Empresa:</th><td>${d.companyName}</td></tr><tr><th>CNPJ:</th><td>${d.companyCnpj || ''}</td></tr><tr><th>Nome do Responsável:</th><td>${d.techName}</td></tr><tr><th>Função / Cargo:</th><td>${d.techRole || 'Responsável Técnico'}</td></tr></tbody></table><h2>3. Relação de Ambientes e Equipamentos</h2><table class="w-full text-sm mt-2"><thead><tr><th>Ambiente</th><th>Equipamento</th><th class="text-center">Qtd</th><th class="text-right">Capacidade</th></tr></thead><tbody>${d.environments.map(env => env.equipments.map(eq => `<tr><td>${env.name}</td><td>${eq.type} ${eq.model}</td><td class="text-center">${eq.qty}</td><td class="text-right">${eq.capacityCool}</td></tr>`).join('')).join('')}</tbody><tfoot><tr class="font-bold bg-gray-200"><td colspan="3" class="text-right">Capacidade Total Instalada:</td><td class="text-right">${calculateTotalBTU(d.environments)} BTU/h</td></tr></tfoot></table></div>${generatePageFooter(d)}</div>`;
            const generateEnvironmentPage = (d, env, index) => `<div class="pmoc-page">${generatePageHeader(d)}<div class="pmoc-page-content"><h2>Plano de Manutenção - Ambiente: ${env.name}</h2><table class="w-full text-sm mb-4"><tbody><tr><th class="w-1/3">Área Climatizada:</th><td>${env.area}</td><th class="w-1/3">Ocupantes Fixos:</th><td>${env.occupantsFixed}</td></tr><tr><th>Tipo de Atividade:</th><td>${env.activity}</td><th>Ocupantes Flutuantes:</th><td>${env.occupantsFloat}</td></tr></tbody></table>${env.equipments.map(eq => `<div class="mb-4"><h3 class="section-title">Equipamento: ${eq.type} (${eq.qty}x) - ${eq.manufacturer} ${eq.model}</h3><table class="w-full text-xs"><tbody><tr><th class="w-1/4">Capacidade Refrig.:</th><td>${eq.capacityCool}</td><th class="w-1/4">Capacidade Aquec.:</th><td>${eq.capacityHeat}</td></tr><tr><th>Gás Refrigerante:</th><td>${eq.gas}</td><th>Tensão:</th><td>${eq.voltage}</td></tr><tr><th>Frequência:</th><td>${eq.frequency}</td><th>Corrente:</th><td>${eq.current}</td></tr></tbody></table></div>`).join('')}<h3 class="section-title">Checklist de Atividades de Manutenção</h3><table class="w-full text-xs mt-4 checklist-table" style="table-layout: fixed;"><thead><tr><th>Atividade de Manutenção</th><th class="text-center">Mensal</th><th class="text-center">Trimestral</th><th class="text-center">Semestral</th></tr></thead><tbody>${env.checklistData.map(item => `<tr><td>${item.task}</td><td class="text-center">${item.m}</td><td class="text-center">${item.t}</td><td class="text-center">${item.s}</td></tr>`).join('')}</tbody></table></div>${generatePageFooter(d)}</div>`;
            
            const generateConclusionPage = (d) => {
                const signatureContent = d.signatureImage
                    ? `<img src="${d.signatureImage}" alt="Assinatura" style="max-height: 80px; margin: 0 auto 10px auto; display: block;">`
                    : `<div style="height: 90px;"></div>`; // Placeholder space if no image

                return `<div class="pmoc-page">${generatePageHeader(d)}
                        <div class="pmoc-page-content flex flex-col">
                            <div>
                                <h2>Conclusão e Recomendações Finais</h2>
                                <p class="text-sm text-justify whitespace-pre-wrap p-4 bg-slate-50 rounded min-h-[400px]">${d.conclusionText}</p>
                            </div>
                             <div class="mt-auto pt-10 text-center">
                                <p class="mb-12">${d.companyCity || 'Betim'}, ${formatDate(d.documentDate)}</p>
                                <div class="w-full max-w-md mx-auto">
                                    ${signatureContent}
                                    <div class="border-t-2 border-slate-700 pt-2">
                                        <p class="font-semibold text-lg">${d.techName}</p>
                                        <p class="text-sm">${d.techRole || 'Responsável Técnico'}</p>
                                        <p class="text-sm">${d.techContact || ''}</p>
                                        <p class="text-sm font-bold mt-2">${d.companyName}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ${generatePageFooter(d)}
                    </div>`;
            };

            // --- FUNÇÃO DE ESCALA DA PRÉ-VISUALIZAÇÃO ---
            function adjustPreviewScaling() {
                const scaler = document.getElementById('preview-scaler');
                const container = DOMElements.editorPreviewContainer;
                if (!scaler || !container) return;

                const firstPage = scaler.querySelector('.pmoc-page');
                if (!firstPage) {
                    container.style.height = 'auto';
                    return;
                }
                
                const containerWidth = container.offsetWidth;
                const pageWidth = firstPage.scrollWidth;

                if (containerWidth < pageWidth) {
                    const scale = containerWidth / pageWidth;
                    scaler.style.transform = `scale(${scale})`;
                    scaler.style.transformOrigin = 'top center';
                    container.style.height = `${scaler.scrollHeight * scale}px`;
                } else {
                    scaler.style.transform = 'none';
                    container.style.height = 'auto';
                }
            }

            // --- FUNÇÕES DE MANIPULAÇÃO DO FORMULÁRIO ---
            function addEnvironment(data = null) {
                const template = document.getElementById('environment-template').firstElementChild.cloneNode(true);
                if (data) {
                    template.querySelector('.env-name').value = data.name || '';
                    template.querySelector('.env-activity').value = data.activity || '';
                    template.querySelector('.env-occupants-fixed').value = data.occupantsFixed || '';
                    template.querySelector('.env-occupants-float').value = data.occupantsFloat || '';
                    template.querySelector('.env-area').value = data.area || '';
                }
                
                const checklistContainer = template.querySelector('.checklist-container');
                const table = document.createElement('table');
                table.className = 'w-full text-xs checklist-table';
                table.innerHTML = `<thead><tr><th>Atividade</th><th class="w-16">Mensal</th><th class="w-16">Trimestral</th><th class="w-16">Semestral</th></tr></thead>`;
                const tbody = document.createElement('tbody');
                checklistTasks.forEach((item, index) => {
                    const savedItem = data?.checklistData?.[index];
                    const row = tbody.insertRow();
                    row.className = 'checklist-row';
                    row.dataset.task = item.task;
                    row.innerHTML = `
                        <td class="pr-2 whitespace-normal">${item.task}</td>
                        <td><input type="text" class="editable-checklist-input checklist-m" value="${savedItem ? savedItem.m : (item.freq === 'M' ? 'X' : '')}"></td>
                        <td><input type="text" class="editable-checklist-input checklist-t" value="${savedItem ? savedItem.t : (item.freq === 'T' ? 'X' : '')}"></td>
                        <td><input type="text" class="editable-checklist-input checklist-s" value="${savedItem ? savedItem.s : (item.freq === 'S' ? 'X' : '')}"></td>
                    `;
                });
                table.appendChild(tbody);
                checklistContainer.appendChild(table);
                
                DOMElements.environmentsContainer.appendChild(template);

                if (data?.equipments) {
                    data.equipments.forEach(equipData => addEquipment(template, equipData));
                }
                
                return template;
            }

            function addEquipment(envElement, data = null) {
                const container = envElement.querySelector('.equipments-container');
                const template = document.getElementById('equipment-template').firstElementChild.cloneNode(true);
                if (data) {
                    template.querySelector('.equip-type').value = data.type || '';
                    template.querySelector('.equip-manufacturer').value = data.manufacturer || '';
                    template.querySelector('.equip-model').value = data.model || '';
                    template.querySelector('.equip-capacity-cool').value = data.capacityCool || '';
                    template.querySelector('.equip-capacity-heat').value = data.capacityHeat || '';
                    template.querySelector('.equip-gas').value = data.gas || '';
                    template.querySelector('.equip-voltage').value = data.voltage || '';
                    template.querySelector('.equip-frequency').value = data.frequency || '';
                    template.querySelector('.equip-current').value = data.current || '';
                    template.querySelector('.equip-qty').value = data.qty || 1;
                }
                container.appendChild(template);
            }
            
            // --- FUNÇÕES DE ESTADO (SAVE/LOAD) ---
            function saveState() {
                const currentState = { ...formState };
                currentState.environments = Array.from(DOMElements.environmentsContainer.querySelectorAll('.environment-item')).map(envEl => ({
                    name: envEl.querySelector('.env-name').value,
                    activity: envEl.querySelector('.env-activity').value,
                    occupantsFixed: envEl.querySelector('.env-occupants-fixed').value,
                    occupantsFloat: envEl.querySelector('.env-occupants-float').value,
                    area: envEl.querySelector('.env-area').value,
                    equipments: Array.from(envEl.querySelectorAll('.equipment-item')).map(eqEl => ({
                        type: eqEl.querySelector('.equip-type').value, manufacturer: eqEl.querySelector('.equip-manufacturer').value, model: eqEl.querySelector('.equip-model').value,
                        capacityCool: eqEl.querySelector('.equip-capacity-cool').value, capacityHeat: eqEl.querySelector('.equip-capacity-heat').value,
                        gas: eqEl.querySelector('.equip-gas').value, voltage: eqEl.querySelector('.equip-voltage').value,
                        frequency: eqEl.querySelector('.equip-frequency').value, current: eqEl.querySelector('.equip-current').value,
                        qty: eqEl.querySelector('.equip-qty').value,
                    })),
                    checklistData: Array.from(envEl.querySelectorAll('.checklist-row')).map(rowEl => ({
                        m: rowEl.querySelector('.checklist-m').value,
                        t: rowEl.querySelector('.checklist-t').value,
                        s: rowEl.querySelector('.checklist-s').value,
                    }))
                }));
                localStorage.setItem('pmocGeneratorState', JSON.stringify(currentState));
                showToast('Progresso salvo com sucesso!');
            }

            function loadState() {
                const savedState = localStorage.getItem('pmocGeneratorState');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    Object.keys(state).forEach(key => {
                        if(key !== 'environments') {
                            formState[key] = state[key];
                            const input = document.getElementById(key);
                            if(input && input.type !== 'file') {
                                input.value = state[key];
                            }
                        }
                    });
                    
                    DOMElements.environmentsContainer.innerHTML = '';
                    if (state.environments) {
                        state.environments.forEach(envData => addEnvironment(envData));
                    }
                    showToast('Progresso anterior carregado.');
                } else {
                    initialData.forEach(envData => addEnvironment(envData));
                }
                
                const introInput = document.getElementById('introText');
                if (!formState.introText) {
                    formState.introText = defaultIntroText;
                }
                introInput.value = formState.introText;
                
                const dateInput = document.getElementById('documentDate');
                if (!formState.documentDate) {
                    dateInput.value = new Date().toISOString().split('T')[0];
                    formState.documentDate = dateInput.value;
                }

                updatePreview();
            }

            // --- BINDING DE EVENTOS ---
            function bindEvents() {
                window.addEventListener('resize', adjustPreviewScaling);

                document.getElementById('add-environment').addEventListener('click', () => { addEnvironment(); updatePreview(); });
                document.getElementById('save-state-button').addEventListener('click', saveState);
                document.getElementById('clear-state-button').addEventListener('click', () => {
                    showModal('Tem certeza que deseja apagar todo o progresso salvo? Esta ação não pode ser desfeita.', () => {
                        localStorage.removeItem('pmocGeneratorState');
                        window.location.reload();
                    });
                });

                DOMElements.inputForm.addEventListener('input', (e) => {
                    if (e.target.matches('input, textarea')) {
                        if (e.target.type !== 'file') {
                            formState[e.target.id] = e.target.value;
                        }
                        updatePreview();
                    }
                });

                DOMElements.environmentsContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('add-equipment')) {
                        addEquipment(e.target.closest('.environment-item'));
                        updatePreview();
                    }
                    if (e.target.classList.contains('remove-environment')) {
                        e.target.closest('.environment-item').remove();
                        updatePreview();
                    }
                    if (e.target.classList.contains('remove-equipment')) {
                        e.target.closest('.equipment-item').remove();
                        updatePreview();
                    }
                });
                DOMElements.environmentsContainer.addEventListener('input', (e) => {
                    if (e.target.matches('input')) {
                        updatePreview();
                    }
                });

                function handleFileUpload(inputId, stateKey) {
                    document.getElementById(inputId).addEventListener('change', function(event) {
                        const file = event.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (e) => { formState[stateKey] = e.target.result; updatePreview(); };
                            reader.readAsDataURL(file);
                        }
                    });
                }
                handleFileUpload('clientLogo', 'clientLogo');
                handleFileUpload('companyLogo', 'companyLogo');
                handleFileUpload('coverImage', 'coverImage');
                handleFileUpload('signatureImage', 'signatureImage');
                
                document.getElementById('removeCoverImage').addEventListener('click', () => {
                    formState.coverImage = null;
                    document.getElementById('coverImage').value = '';
                    updatePreview();
                    showToast('Imagem da capa removida.');
                });

                document.getElementById('removeSignatureImage').addEventListener('click', () => {
                    formState.signatureImage = null;
                    document.getElementById('signatureImage').value = '';
                    updatePreview();
                    showToast('Imagem da assinatura removida.');
                });


                document.getElementById('prepare-print-button').addEventListener('click', () => {
                    DOMElements.printContentContainer.innerHTML = generatePMOCHTML();
                    updatePagination(DOMElements.printContentContainer);
                    DOMElements.editorContainer.style.display = 'none';
                    DOMElements.printContainer.style.display = 'block';
                });
                document.getElementById('back-to-editor-button').addEventListener('click', () => {
                    DOMElements.editorContainer.style.display = 'grid';
                    DOMElements.printContainer.style.display = 'none';
                });
                
                async function waitForImagesToLoad(element) {
                    const images = Array.from(element.querySelectorAll('img'));
                    const promises = images.map(img => {
                        return new Promise((resolve) => {
                            if (img.complete && img.naturalHeight !== 0) {
                                resolve();
                            } else {
                                img.onload = resolve;
                                img.onerror = resolve; // Resolve on error too, so it doesn't hang forever
                            }
                        });
                    });
                    return Promise.all(promises);
                }

                document.getElementById('save-pdf-button').addEventListener('click', async (e) => {
                    const button = e.currentTarget;
                    const originalText = button.innerHTML;
                    button.disabled = true;
                    button.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Gerando...`;

                    try {
                        const { jsPDF } = window.jspdf;
                        const printContent = document.getElementById('pmoc-for-print');
                        const pages = printContent.querySelectorAll('.pmoc-page');
                        const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });

                        for (let i = 0; i < pages.length; i++) {
                            const page = pages[i];
                            await waitForImagesToLoad(page); // Espera as imagens carregarem
                            const canvas = await html2canvas(page, { scale: 2, useCORS: true, logging: false });
                            const imgData = canvas.toDataURL('image/jpeg', 0.95);
                            const pdfWidth = doc.internal.pageSize.getWidth();
                            const pdfHeight = doc.internal.pageSize.getHeight();
                            if (i > 0) doc.addPage();
                            doc.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                        }
                        
                        const fileName = `pmoc-${formState.clientName || 'documento'}.pdf`.replace(/[^a-z0-9_.-]/gi, '_').toLowerCase();
                        doc.save(fileName);

                    } catch (error) {
                        console.error("Erro ao gerar PDF:", error);
                        showToast("Ocorreu um erro ao gerar o PDF.");
                    } finally {
                        button.disabled = false;
                        button.innerHTML = originalText;
                    }
                });
            }

            // --- INICIALIZAÇÃO ---
            loadState();
            bindEvents();
        });
    </script>
</body>
</html>
